# Руководство по улучшению релевантности поиска RAG

## Возможные причины нерелевантных результатов

### 1. **Несоответствие task_type при создании эмбеддингов**
   - **Проблема**: FAISS индексы могли быть созданы с `task_type="RETRIEVAL_DOCUMENT"`, а поиск идёт с `task_type="RETRIEVAL_QUERY"`
   - **Решение**: Убедиться, что оба используют совместимые task_type
   - **Проверка**: Посмотреть скрипт создания индексов

### 2. **Проблемы с Query Expansion**
   - **Проблема**: Расширенные варианты запроса могут уводить от темы
   - **Решение**: Отключить query expansion или улучшить алгоритм
   - **Тест**: Попробовать поиск с `expand_query=False`

### 3. **Низкое качество чанкирования**
   - **Проблема**: Чанки текста могут быть слишком большими или маленькими
   - **Решение**: Пересоздать индексы с лучшим чанкированием
   - **Опт имально**: 200-500 символов на чанк для религиозных текстов

### 4. **Проблемы с reranking**
   - **Проблема**: Reranker может менять порядок результатов неправильно
   - **Решение**: Отключить reranking или использовать другую модель
   - **Тест**: Попробовать поиск с `use_reranking=False`

### 5. **Проблемы с нормализацией векторов**
   - **Проблема**: Вектора могут не нормализоваться правильно
   - **Решение**: Проверить, что и индексы, и запросы нормализованы одинаково

## Тестирование

### Базовый тест (без расширения и reranking)
```bash
curl -X POST http://localhost:5000/api/search \
  -H "Content-Type: application/json" \
  -d '{"query": "душа", "language": "ru", "top_k": 3, "use_reranking": false, "expand_query": false}'
```

### Тест с логированием
Смотрите логи rag_api_server.py для деталей:
- Варианты запроса
- Размерность эмбеддингов
- Количество найденных результатов для каждого варианта

### Ручная проверка релевантности
```python
python test_relevance.py
```

## Рекомендации

1. **Сначала проверьте без опций**: `expand_query=False`, `use_reranking=False`
2. **Проверьте логи**: Убедитесь, что эмбеддинги имеют правильную размерность (768)
3. **Проверьте сами эмбеддинги**: Возможно, нужно пересоздать FAISS индексы с правильным task_type
4. **Попробуйте другие запросы**: Некоторые запросы могут работать лучше других

## Если проблема в индексах

Если окажется, что индексы созданы с неправильным task_type, их нужно пересоздать:

```python
# В скрипте создания индексов должно быть:
genai.embed_content(
    model="models/text-embedding-004",
    content=text,
    task_type="RETRIEVAL_DOCUMENT"  # ДЛЯ ДОКУМЕНТОВ
)

# А в поиске:
genai.embed_content(
    model="models/text-embedding-004",
    content=query,
    task_type="RETRIEVAL_QUERY"  # ДЛЯ ЗАПРОСОВ
)
```
